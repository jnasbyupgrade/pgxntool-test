---
description: Create a git commit following project standards and safety protocols
allowed-tools: Bash(git status:*), Bash(git log:*), Bash(git add:*), Bash(git diff:*), Bash(git commit:*), Bash(make test-bats:*), Bash(make test:*)
---

# commit

Create a git commit following all project standards and safety protocols for pgxntool-test.

**CRITICAL REQUIREMENTS:**

1. **Git Safety**: Never update git config, never force push to main/master, never skip hooks unless explicitly requested

2. **Commit Attribution**: Do NOT add "Generated with Claude Code" to commit message body. The standard Co-Authored-By trailer is acceptable per project CLAUDE.md.

3. **Testing**: Ensure tests pass before committing:
   - For BATS work (preferred): Run `make test-bats` and verify all pass
   - For legacy test work: Run `make test` and check for `diffs/*.diff` files
   - When in doubt, run both test suites

4. **Expected Output Files**: NEVER commit changes to `expected/*.out` files without explicit user approval. If tests pass with different output, tell user to run `make sync-expected` themselves.

**WORKFLOW:**

1. Run in parallel: `git status`, `git diff --stat`, `git log -10 --oneline`

2. Check test status:
   - Look at git status output - any `diffs/*.diff` files indicate legacy test failures
   - If working on BATS tests, check those pass: `make test-bats 2>&1 | tail -20`
   - If any changes to `expected/*.out`, STOP and inform user (must run `make sync-expected`)
   - NEVER commit with failing tests

3. Analyze changes and draft concise commit message following this repo's style:
   - Look at `git log -10 --oneline` to match existing style
   - Be factual and direct (e.g., "Fix BATS dist test to create its own distribution")
   - Focus on "why" when it adds value, otherwise just describe "what"
   - List items in roughly decreasing order of impact
   - Keep related items grouped together

4. **PRESENT the proposed commit message to the user and WAIT for approval before proceeding**

5. After receiving approval, stage changes and commit using HEREDOC format:
```bash
# Stage changes (or specific files if user requested)
git add -A

# Commit with heredoc for clean formatting
git commit -m "$(cat <<'EOF'
Subject line (imperative mood, < 72 chars)

Additional context if needed, wrapped at 72 characters.

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

6. Run `git status` after commit to verify success

7. If pre-commit hook modifies files: Check authorship (`git log -1 --format='%an %ae'`) and branch status, then amend if safe or create new commit

**REPOSITORY CONTEXT:**

This is pgxntool-test, a test harness for the pgxntool framework. Key facts:
- Tests live in `tests/` (legacy) and `tests-bats/` (preferred for new work)
- `.envs/` contains test environments (gitignored)
- `expected/` contains expected test outputs (NEVER modify without approval)
- `results/` contains actual test outputs (generated by tests)
- `diffs/` contains differences when tests fail (generated by tests)

**RESTRICTIONS:**
- DO NOT push unless explicitly asked
- DO NOT run additional commands to explore code (only git and make test commands)
- DO NOT commit files with actual secrets (credentials.json, etc.)
- DO NOT commit changes to `expected/*.out` without user running `make sync-expected`
- Never use `-i` flags (git commit -i, git rebase -i, etc.)
